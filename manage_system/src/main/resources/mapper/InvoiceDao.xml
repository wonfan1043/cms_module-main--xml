<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.inext.manage_system.dao.invoice.InvoiceDao">

    <!-- 請求書存在チェック -->
    <select id="searchInvoiceByInvoiceNo" resultType="int">
        SELECT invoice_no
        FROM invoice
        WHERE invoice_no = #{invoiceNo}
    </select>

    <!-- 請求書作成 -->
    <insert id="createInvoice" parameterType="com.inext.manage_system.model.invoice.Invoice">
        INSERT INTO invoice (invoice_no, corp_id, topic_id, bank_id, memo, tax, other, due_date, charge_date, creater, create_datetime)
        VALUES (#{invoiceNo},  #{corpId},  #{topicId},  #{bankId},  #{memo},  #{tax},  #{other},  #{dueDate},  #{chargeDate},  #{creater},  #{createDateTime})
    </insert>

    <!-- 請求書更新 -->
    <update id="updateInvoice" parameterType="com.inext.manage_system.model.invoice.Invoice">
        UPDATE invoice
        SET corp_id = #{corpId}, topic_id = #{topicId}, bank_id = #{bankId}, memo = #{memo}, tax = #{tax}, other = #{other}, due_date = #{dueDate}, charge_date = #{chargeDate}, updater = #{updater}, update_datetime = #{updateDateTime}
        WHERE invoice_no = #{invoiceNo}
        AND `delete` = 0
    </update>

    <!-- 条件なしで請求書検索 -->
    <select id="searchAllInvoice" resultType="com.inext.manage_system.vo.SearchInvoiceRes">
        SELECT invoice_no, charge_date, create_datetime
        FROM invoice
        WHERE `delete` = 0
    </select>

    <!-- 時間帯のみで請求書検索 -->
    <select id="searchInvoiceByTime" parameterType="int" resultType="com.inext.manage_system.vo.SearchInvoiceRes">
        SELECT invoice_no, charge_date, create_datetime
        FROM invoice
        WHERE YEAR(create_datetime) = #{year} AND MONTH(create_datetime) = #{month}
        AND `delete` = 0
    </select>

    <!-- 会社サンプルのみで請求書検索 -->
    <select id="searchInvoiceByCompany" parameterType="int" resultType="com.inext.manage_system.vo.SearchInvoiceRes">
        SELECT invoice_no, charge_date, create_datetime
        FROM invoice
        WHERE corp_id = #{corpId}
        AND `delete` = 0
    </select>

    <!-- 時間帯と会社サンプルで請求書検索 -->
    <select id="searchInvoiceByTimeAndCompany" parameterType="int" resultType="com.inext.manage_system.vo.SearchInvoiceRes">
        SELECT invoice_no, charge_date, create_datetime
        FROM invoice
        WHERE YEAR(create_datetime) = #{year} AND MONTH(create_datetime) = #{month} AND corp_id = #{corpId}
        AND `delete` = 0
    </select>

    <!-- 請求書詳細抽出 -->
    <select id="checkInvoice" resultType="com.inext.manage_system.vo.InvoiceContentRes">
        SELECT i.corp_id, i.topic_id, i.bank_id, i.memo, i.tax, i.other, i.due_date, i.create_datetime, c.item_id, c.quantity, c.unit_price
        FROM invoice AS i
        JOIN charge_content AS c
        ON i.invoice_no = c.invoice_no
        WHERE i.invoice_no = #{invoiceNo} AND i.delete = 0 AND c.delete =0
    </select>

    <!-- 請求書削除 -->
    <update id="updateInvoice" parameterType="com.inext.manage_system.model.invoice.Invoice">
        UPDATE invoice
        SET updater= #{updater}, updateDateTime = #{updateDateTime}, `delete` = 1
        WHERE invoice_no = #{invoiceNo}
    </update>

</mapper>